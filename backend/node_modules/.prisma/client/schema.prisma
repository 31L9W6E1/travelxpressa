generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// User model
model User {
  id            String  @id @default(cuid())
  email         String  @unique
  password      String
  name          String
  role          String  @default("USER") // USER, ADMIN, AGENT
  emailVerified Boolean @default(false)

  // Profile fields
  phone     String?
  country   String?
  avatarUrl String? // URL to profile picture or auto-generated avatar

  // Security
  lastLoginAt  DateTime?
  lastLoginIp  String?
  failedLogins Int       @default(0)
  lockedUntil  DateTime?

  // 2FA
  twoFactorEnabled Boolean @default(false)
  twoFactorSecret  String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  applications  Application[]
  inquiries     Inquiry[]
  refreshTokens RefreshToken[]
  auditLogs     AuditLog[]
  chatThreads   ChatThread[]
}

// Refresh token model for secure token rotation
model RefreshToken {
  id         String    @id @default(cuid())
  token      String    @unique
  userId     String
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt  DateTime
  createdAt  DateTime  @default(now())
  revokedAt  DateTime?
  replacedBy String? // For token rotation tracking
}

// DS-160 Application model
model Application {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Application metadata
  visaType    String // B1_B2, F1, J1, H1B, L1, O1, K1, OTHER
  status      String @default("DRAFT") // DRAFT, IN_PROGRESS, SUBMITTED, UNDER_REVIEW, COMPLETED, REJECTED
  currentStep Int    @default(1)

  // Form sections (encrypted JSON data)
  personalInfo  String? // Encrypted JSON
  contactInfo   String? // Encrypted JSON
  passportInfo  String? // Encrypted JSON
  travelInfo    String? // Encrypted JSON
  familyInfo    String? // Encrypted JSON
  workEducation String? // Encrypted JSON
  securityInfo  String? // Encrypted JSON

  // Additional info
  photoUrl           String?
  confirmationNumber String?

  // Admin fields
  adminNotes String?
  reviewedBy String?
  reviewedAt DateTime?

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  submittedAt DateTime?
}

// Inquiry model
model Inquiry {
  id     String  @id @default(cuid())
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Contact info
  name    String
  email   String
  phone   String
  message String

  // Inquiry details
  serviceType String // VISA_APPLICATION, TOURISM_PACKAGE, CONSULTATION, DOCUMENT_REVIEW
  status      String @default("PENDING") // PENDING, IN_PROGRESS, APPROVED, REJECTED, COMPLETED

  // Admin fields
  adminNotes String?
  assignedTo String?
  resolvedAt DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Audit log for compliance and security
model AuditLog {
  id     String  @id @default(cuid())
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  action   String
  entity   String
  entityId String?

  // Request details
  ipAddress String?
  userAgent String?

  // Change tracking
  oldData String? // JSON
  newData String? // JSON

  // Metadata
  metadata String? // JSON

  createdAt DateTime @default(now())
}

// Session model for secure session management
model Session {
  id        String @id @default(cuid())
  sessionId String @unique
  userId    String

  // Session data
  data String? // JSON

  // Security
  ipAddress String?
  userAgent String?

  // Timestamps
  createdAt DateTime @default(now())
  expiresAt DateTime
}

// Payment model for monetization
model Payment {
  id     String @id @default(cuid())
  userId String

  // Payment details
  amount   Int // Amount in cents
  currency String @default("USD")
  status   String // pending, completed, failed, refunded

  // Provider info
  provider          String // stripe, paddle, etc.
  providerPaymentId String?

  // Service details
  serviceType String
  description String?

  // Invoice
  invoiceNumber String? @unique
  invoiceUrl    String?

  // Timestamps
  createdAt   DateTime  @default(now())
  completedAt DateTime?
}

// Chat Thread model for user support
model ChatThread {
  id            String  @id @default(cuid())
  userId        String
  user          User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  applicationId String? // Optional link to an application

  // Thread metadata
  subject String?
  status  String  @default("OPEN") // OPEN, CLOSED, PENDING

  // Telegram integration
  telegramChatId String? @unique

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  closedAt  DateTime?

  // Relations
  messages ChatMessage[]
}

// Chat Message model
model ChatMessage {
  id       String     @id @default(cuid())
  threadId String
  thread   ChatThread @relation(fields: [threadId], references: [id], onDelete: Cascade)

  // Message content
  content     String
  messageType String @default("TEXT") // TEXT, IMAGE, FILE, SYSTEM

  // Sender info
  senderId   String? // null for system messages
  senderType String // USER, ADMIN, SYSTEM, TELEGRAM

  // Telegram integration
  telegramMessageId String?

  // Read status
  isRead Boolean @default(false)

  // Timestamps
  createdAt DateTime @default(now())
}

// CMS Post model for Blog and News content
model Post {
  id String @id @default(cuid())

  // Content fields
  title   String
  slug    String  @unique
  excerpt String? // Short description
  content String // Full body content

  // Media
  imageUrl String?

  // Categorization
  category String // blog, news
  tags     String? // Comma-separated tags

  // Publishing
  status      String    @default("draft") // draft, published
  publishedAt DateTime?

  // Author (optional)
  authorId   String?
  authorName String?

  // SEO
  metaTitle       String?
  metaDescription String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
